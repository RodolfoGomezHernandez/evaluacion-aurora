<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluaci√≥n de Desempe√±o - Aurora Australis S.A.</title>
    
    <!-- React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para compilar JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS para Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Firebase SDKs (Compatibles) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #f0fdf4; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .input-field { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background-color: #f9fafb; transition: all 0.2s; }
        .input-field:focus { border-color: #16a34a; outline: none; ring: 2px solid #16a34a; background-color: white; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; cursor: pointer; }
        .btn-primary { background-color: #15803d; color: white; }
        .btn-primary:hover { background-color: #14532d; shadow: 0 4px 6px -1px rgba(21, 128, 61, 0.4); }
        .radio-label { cursor: pointer; transition: all 0.2s; user-select: none; }
        .radio-label:hover { background-color: #f0fdf4; transform: translateY(-1px); }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #16a34a; width: 20px; height: 20px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        .avatar-img { width: 80px; height: 80px; object-fit: cover; border-radius: 50%; border: 3px solid #16a34a; background-color: #fff; }
        .avatar-placeholder { width: 80px; height: 80px; border-radius: 50%; background-color: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #9ca3af; border: 3px solid #d1d5db; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // --- 1. CONFIGURACI√ìN DE FIREBASE ---
        // IMPORTANTE: Si creaste un proyecto nuevo, reemplaza esto con tus nuevas credenciales.
        const firebaseConfig = {
            apiKey: "AIzaSyCX-X4DAFfA6_U19NbnAPVgpmleYMveaMk",
            authDomain: "evaluacion-aurora.firebaseapp.com",
            projectId: "evaluacion-aurora",
            storageBucket: "evaluacion-aurora.firebasestorage.app",
            messagingSenderId: "597070461794",
            appId: "1:597070461794:web:c236693c4d2a05c0428a3b"
        };

        // Inicializaci√≥n segura
        let db = null;
        let auth = null;
        let firebaseReady = false;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            } else {
                firebase.app(); 
            }
            db = firebase.firestore();
            auth = firebase.auth();
            firebaseReady = true;
        } catch (error) { console.error("Error inicializando Firebase:", error); }

        // --- 2. BASE DE DATOS DE PERSONAL ---
        const JEFATURAS = [
            { nombre: "Germ√°n Samaniego", cargo: "Gerente General", area: "Gerencia General", rut: "" },
            { nombre: "Robinson Fuentes", cargo: "Gerente Adm. y Finanzas", area: "Adm. y Finanzas", rut: "" },
            { nombre: "Francisco Carrasco", cargo: "Gerente Operaciones", area: "Operaciones", rut: "" },
            { nombre: "Jer√≥nimo Concha", cargo: "Gerente T√©cnico", area: "Gerencia T√©cnica", rut: "" },
            { nombre: "Gianina Salazar", cargo: "Gerente Aseg. Calidad", area: "Aseguramiento de Calidad", rut: "" },
            { nombre: "Carla Fern√°ndez", cargo: "Jefe Desarrollo Org.", area: "RRHH", rut: "" },
            { nombre: "Valentina Mu√±oz", cargo: "Jefe Comex", area: "Comex", rut: "" },
            { nombre: "Alejandro Mardones", cargo: "Jefe Inform√°tica/Compras", area: "Adm. y Finanzas", rut: "" },
            { nombre: "Jos√© Ayala", cargo: "Jefe Contabilidad", area: "Adm. y Finanzas", rut: "" },
            { nombre: "Andrea El√≠as", cargo: "Jefe Remuneraciones", area: "RRHH", rut: "" },
            { nombre: "Tamara Ortega", cargo: "Encargada Tesorer√≠a", area: "Adm. y Finanzas", rut: "" },
            { nombre: "Claudio Castro", cargo: "Jefe Planta", area: "Operaciones", rut: "018.806.604-6" },
            { nombre: "Rodrigo Astudillo", cargo: "Jefe Packing", area: "Operaciones", rut: "010.203.356-6" },
            { nombre: "Daniel Madrid", cargo: "Jefe Frigor√≠fico", area: "Operaciones", rut: "" },
            { nombre: "Alex Silva", cargo: "Jefe Bodega", area: "Operaciones", rut: "" },
            { nombre: "Emanuel Navarro", cargo: "Jefe Mantenci√≥n", area: "Operaciones", rut: "" },
            { nombre: "Guillermo Negrete", cargo: "Jefe Sala de M√°quinas", area: "Operaciones", rut: "" },
            { nombre: "Elizabeth Espina", cargo: "Jefa Aseg. Calidad y SGI", area: "Aseguramiento de Calidad", rut: "" }
        ];

        const PERSONAL_DB = [
            // ADM & FINANZAS
            { nombre: "JOSE ENRIQUE GUERRERO REYES", area: "Adm. y Finanzas", rut: "007.327.405-2" },
            { nombre: "LUIS ARMANDO MU√ëOZ GUERRERO", area: "Adm. y Finanzas", rut: "007.855.334-0" },
            { nombre: "PEDRO PABLO CAMPOS CONCHA", area: "Adm. y Finanzas", rut: "010.142.169-4" },
            { nombre: "JUAN CARLOS CORDOVA ZAMORANO", area: "Adm. y Finanzas", rut: "012.782.679-K" },
            { nombre: "HERNAN ALEJANDRO GUERRERO GUERRERO", area: "Adm. y Finanzas", rut: "014.051.289-3" },
            { nombre: "MARYORIE ALEJANDRA ROJAS URRA", area: "Adm. y Finanzas", rut: "016.802.552-1" },
            { nombre: "RICARDO ALEXIS ARRIAGADA QUEZADA", area: "Adm. y Finanzas", rut: "016.858.625-6" },
            { nombre: "RODOLFO ANTONIO GOMEZ HERNANDEZ", area: "Adm. y Finanzas", rut: "018.681.549-1" },
            // RRHH
            { nombre: "LORETO CRISTINA ALIAGA ORTEGA", area: "RRHH", rut: "015.630.480-8" },
            { nombre: "JESUS ABRAHAM GARCIA DE LA FUENTE", area: "RRHH", rut: "017.795.964-2" },
            // OPERACIONES
            { nombre: "CARMEN GLORIA GUAJARDO BENITEZ", area: "Operaciones", rut: "014.014.966-7" },
            { nombre: "KAREN ELIZABETH GONZALEZ MORALES", area: "Operaciones", rut: "017.873.574-8" },
            { nombre: "EDUARDO ALEXIS HILA VALDES", area: "Operaciones", rut: "017.980.737-8" },
            { nombre: "CRISTOBAL MARCELO SOLIS VALENZUELA", area: "Operaciones", rut: "018.560.986-3" },
            { nombre: "JUAN CARLOS CRUZ LOPEZ", area: "Operaciones", rut: "018.561.018-7" },
            { nombre: "CLAUDIO HERNAN CASTRO CASTRO", area: "Operaciones", rut: "018.806.604-6" },
            { nombre: "SERGIO ESTEBAN GAVILAN MORALES", area: "Operaciones", rut: "019.250.095-8" },
            { nombre: "EXEQUIEL IGNACIO SANTANA", area: "Operaciones", rut: "019.552.835-7" },
            { nombre: "GLORIA CAROLINA MORAGA SEPULVEDA", area: "Operaciones", rut: "009.738.046-5" },
            { nombre: "EDUARDO ENRIQUE MU√ëOZ SOTO", area: "Operaciones", rut: "009.743.891-9" },
            { nombre: "AILIN LARA BARZAGA", area: "Operaciones", rut: "028.962.741-3" },
            { nombre: "ESTHEFANY MARGARITA MARQUEZ MARTINEZ", area: "Operaciones", rut: "027.157.080-5" },
            { nombre: "LEWYN DAEL ZURITA GIL", area: "Operaciones", rut: "027.081.591-K" },
            { nombre: "ANTHONY JOSE MACHADO GUTIERREZ", area: "Operaciones", rut: "026.947.757-1" },
            { nombre: "RODRIGO ALEJANDRO ASTUDILLO CORTES", area: "Operaciones", rut: "010.203.356-6" },
            // T√âCNICA Y CALIDAD (Jefaturas cruzadas)
            { nombre: "Diego Hormazabal", area: "Gerencia T√©cnica", rut: "" },
            { nombre: "Leonardo Zamora", area: "Gerencia T√©cnica", rut: "" },
            { nombre: "Luis Barrientos", area: "Gerencia T√©cnica", rut: "" },
            { nombre: "Heimy Fuenzalida", area: "Aseguramiento de Calidad", rut: "" },
            { nombre: "Masiel Iba√±ez", area: "Aseguramiento de Calidad", rut: "" }
        ];

        const App = () => {
            const [evaluadorJson, setEvaluadorJson] = useState(""); 
            const [areaObjetivo, setAreaObjetivo] = useState("");
            const [evaluadoObj, setEvaluadoObj] = useState(null); 
            const [scores, setScores] = useState({ rendimiento: null, compromiso: null, frustracion: null, responsabilidad: null });
            const [comentario, setComentario] = useState("");
            const [history, setHistory] = useState([]);
            const [mensaje, setMensaje] = useState("");
            const [isSaving, setIsSaving] = useState(false);
            const [isDownloading, setIsDownloading] = useState(false);
            const [user, setUser] = useState(null);

            // AUTO-LOGIN AN√ìNIMO AL INICIAR
            useEffect(() => {
                if (firebaseReady && auth) {
                    auth.onAuthStateChanged((u) => {
                        if (u) {
                            setUser(u);
                        } else {
                            auth.signInAnonymously().catch(e => console.error("Error Auth:", e));
                        }
                    });
                }
            }, []);

            // Cargar historial en tiempo real
            useEffect(() => {
                if (firebaseReady && db) {
                    const unsubscribe = db.collection("evaluaciones").orderBy("id", "desc").onSnapshot((s) => {
                        setHistory(s.docs.map(d => d.data()));
                    }, (error) => {
                        console.error("Error cargando historial:", error);
                    });
                    return () => unsubscribe();
                }
            }, [user]);

            // Filtros Inteligentes
            const areasUnicas = useMemo(() => [...new Set(PERSONAL_DB.map(p => p.area))].sort(), []);
            
            const personalFiltrado = useMemo(() => {
                if (!areaObjetivo) return [];
                let lista = PERSONAL_DB.filter(p => p.area === areaObjetivo);
                if (evaluadorJson) {
                    try {
                        const evaluadorObj = JSON.parse(evaluadorJson);
                        lista = lista.filter(p => p.nombre.toLowerCase().trim() !== evaluadorObj.nombre.toLowerCase().trim());
                        const yaEvaluados = new Set(
                            history
                                .filter(h => h.evaluador_nombre === evaluadorObj.nombre)
                                .map(h => h.evaluado_nombre)
                        );
                        lista = lista.filter(p => !yaEvaluados.has(p.nombre));
                    } catch(e) {}
                }
                return lista.sort((a, b) => a.nombre.localeCompare(b.nombre));
            }, [areaObjetivo, evaluadorJson, history]);

            const handleScore = (key, val) => setScores(prev => ({ ...prev, [key]: parseInt(val) }));
            const handleEvaluadoChange = (e) => {
                const nombre = e.target.value;
                const persona = personalFiltrado.find(p => p.nombre === nombre);
                setEvaluadoObj(persona || null);
            };

            const guardarEvaluacion = async () => {
                if (!evaluadorJson || !evaluadoObj || Object.values(scores).some(v => v === null)) {
                    setMensaje("‚ö†Ô∏è Faltan campos."); 
                    setTimeout(() => setMensaje(""), 3000); 
                    return;
                }
                
                setIsSaving(true);
                const evaluadorData = JSON.parse(evaluadorJson);
                const promedio = Object.values(scores).reduce((a, b) => a + b, 0) / 4;

                const registro = {
                    id: Date.now(),
                    fecha: new Date().toLocaleDateString("es-CL"),
                    evaluador_nombre: evaluadorData.nombre, 
                    evaluador_cargo: evaluadorData.cargo,
                    evaluador_area: evaluadorData.area,
                    evaluado_nombre: evaluadoObj.nombre,
                    evaluado_rut: evaluadoObj.rut || "S/I", 
                    evaluado_area: areaObjetivo,
                    ...scores,
                    promedio: promedio.toFixed(2),
                    comentarios: comentario || "Sin comentarios"
                };

                if (firebaseReady && db) {
                    try {
                        // Asegurar login antes de guardar
                        if (!auth.currentUser) await auth.signInAnonymously();
                        
                        await db.collection("evaluaciones").add(registro);
                        setMensaje("‚úÖ Guardado exitosamente.");
                    } catch (e) {
                        console.error(e);
                        setMensaje("‚ùå Error en Nube: " + e.message);
                        // Fallback local visual
                        setHistory([registro, ...history]);
                    }
                } else {
                    setHistory([registro, ...history]);
                    setMensaje("‚ö†Ô∏è Guardado Local (Offline).");
                }
                
                setIsSaving(false); 
                setEvaluadoObj(null); 
                setScores({ rendimiento: null, compromiso: null, frustracion: null, responsabilidad: null }); 
                setComentario("");
                setTimeout(() => setMensaje(""), 3000);
            };

            const exportarExcel = async () => {
                setIsDownloading(true);
                let datosRaw = [];
                try {
                    if (firebaseReady && db) {
                        if (!auth.currentUser) await auth.signInAnonymously();
                        const snapshot = await db.collection("evaluaciones").get();
                        datosRaw = snapshot.docs.map(doc => doc.data());
                    } else {
                        datosRaw = history;
                    }

                    if (datosRaw.length === 0) {
                        alert("No hay datos para exportar.");
                        setIsDownloading(false);
                        return;
                    }

                    const datosAnonimos = datosRaw.map(item => {
                        const { evaluador_nombre, evaluador_cargo, evaluador_area, id, ...resto } = item;
                        return { ...resto, "Origen": "BD", "Confidencial": "SI" };
                    });

                    const ws = XLSX.utils.json_to_sheet(datosAnonimos);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Evaluaciones");
                    XLSX.writeFile(wb, "Evaluaciones_Confidenciales_Aurora.xlsx");
                } catch (error) {
                    alert("Error al exportar: " + error.message);
                }
                setIsDownloading(false);
            };

            const niveles = [
                { val: 0, label: "Nulo", color: "bg-red-100 text-red-700 border-red-200" },
                { val: 1, label: "Medio", color: "bg-orange-100 text-orange-700 border-orange-200" },
                { val: 2, label: "Bueno", color: "bg-yellow-100 text-yellow-700 border-yellow-200" },
                { val: 3, label: "Excelente", color: "bg-green-100 text-green-700 border-green-200" }
            ];

            const getFotoUrl = (rut) => {
                if (!rut) return null;
                const cleanRut = rut.replace(/^0+/, ''); 
                return `./fotos/${cleanRut}.jpg`;
            };

            return (
                <div className="max-w-6xl mx-auto p-4 md:p-8">
                    <header className="mb-8 flex flex-col md:flex-row justify-between items-center border-b pb-4 border-green-200 gap-4">
                        <div className="flex items-center gap-4">
                            <div className="w-14 h-14 bg-green-700 rounded-xl flex items-center justify-center text-white font-bold text-2xl shadow-lg">AA</div>
                            <div>
                                <h1 className="text-3xl font-bold text-gray-800 tracking-tight">Evaluaci√≥n 360¬∞</h1>
                                <p className="text-green-700 font-semibold text-sm">Aurora Australis S.A.</p>
                            </div>
                        </div>
                        <div className="text-right flex items-center gap-3">
                             <div className={`text-xs px-3 py-1 rounded-full border font-bold flex items-center gap-2 ${firebaseReady ? 'bg-green-50 text-green-700 border-green-200' : 'bg-red-50 text-red-700 border-red-200'}`}>
                                <div className={`w-2 h-2 rounded-full ${firebaseReady ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                {firebaseReady ? 'Conectado' : 'Modo Local'}
                                {user && <span className="hidden md:inline ml-1 opacity-75">| ID: {user.uid.slice(0,4)}...</span>}
                            </div>
                        </div>
                    </header>

                    <div className="grid lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2 space-y-6">
                            <div className="card p-6 border-l-4 border-green-600">
                                <h2 className="text-lg font-bold text-gray-700 mb-4 flex items-center gap-2">
                                    <svg className="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg> Identificaci√≥n
                                </h2>
                                <div className="mb-5">
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Tu Identidad (Evaluador)</label>
                                    <select className="input-field font-medium text-gray-800 text-lg" value={evaluadorJson} onChange={(e) => setEvaluadorJson(e.target.value)}>
                                        <option value="">-- Selecciona qui√©n eres --</option>
                                        {JEFATURAS.map((j, i) => (
                                            <option key={i} value={JSON.stringify(j)}>{j.nombre} ({j.cargo})</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg border border-gray-100">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">√Årea a Evaluar</label>
                                        <select className="input-field" value={areaObjetivo} onChange={(e) => { setAreaObjetivo(e.target.value); setEvaluadoObj(null); }}>
                                            <option value="">-- Filtrar por √Årea --</option>
                                            {areasUnicas.map(a => <option key={a} value={a}>{a}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Colaborador</label>
                                        <select className="input-field" value={evaluadoObj ? evaluadoObj.nombre : ""} onChange={handleEvaluadoChange} disabled={!areaObjetivo}>
                                            <option value="">{areaObjetivo ? (personalFiltrado.length > 0 ? `-- Seleccionar Persona --` : "-- Todos Evaluados --") : "-- Esperando √Årea --"}</option>
                                            {personalFiltrado.map((p, i) => (<option key={i} value={p.nombre}>{p.nombre}</option>))}
                                        </select>
                                    </div>
                                </div>
                                {evaluadorJson && areaObjetivo && (
                                    <p className="text-[10px] text-gray-400 mt-2 text-right italic">* Los nombres ya evaluados por ti no aparecen en la lista.</p>
                                )}
                            </div>

                            <div className="card p-6 relative min-h-[500px]">
                                {!evaluadorJson || !evaluadoObj ? (
                                    <div className="absolute inset-0 bg-white/95 z-10 flex flex-col items-center justify-center text-center p-6 rounded-xl backdrop-blur-sm">
                                        <div className="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4 text-gray-400 shadow-inner">
                                            <svg className="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                        </div>
                                        <h3 className="font-bold text-xl text-gray-700">Esperando selecci√≥n</h3>
                                        <p className="text-gray-500 mt-2">Completa la configuraci√≥n arriba para desbloquear el formulario.</p>
                                    </div>
                                ) : (
                                    <div className="flex flex-col sm:flex-row items-center gap-6 mb-8 p-6 bg-gradient-to-r from-green-50 to-white rounded-xl border border-green-100 shadow-sm">
                                        <div className="relative">
                                            <img 
                                                src={getFotoUrl(evaluadoObj.rut)} 
                                                alt={evaluadoObj.nombre} 
                                                className="avatar-img shadow-md bg-white"
                                                onError={(e) => {
                                                    e.target.style.display = 'none';
                                                    e.target.nextSibling.style.display = 'flex';
                                                }}
                                            />
                                            <div className="avatar-placeholder shadow-md" style={{display: 'none'}}>
                                                {evaluadoObj.nombre.charAt(0)}
                                            </div>
                                        </div>
                                        <div className="text-center sm:text-left">
                                            <h3 className="font-bold text-gray-800 text-xl">{evaluadoObj.nombre}</h3>
                                            <p className="text-green-700 font-medium">{evaluadoObj.area}</p>
                                            <div className="inline-block bg-gray-200 rounded px-2 py-1 mt-2 text-xs font-mono text-gray-600">
                                                RUT: {evaluadoObj.rut || "No registrado"}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <h2 className="text-lg font-bold text-gray-700 mb-6 border-b pb-2">Criterios de Desempe√±o</h2>
                                {['rendimiento', 'compromiso', 'frustracion', 'responsabilidad'].map((id, index) => (
                                    <div key={id} className="mb-8">
                                        <div className="flex items-baseline justify-between mb-3">
                                            <label className="block font-bold text-gray-700 capitalize text-lg">
                                                {index + 1}. {id === 'frustracion' ? 'Manejo de Frustraci√≥n' : id}
                                            </label>
                                        </div>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                            {niveles.map((n) => (
                                                <label key={n.val} className={`radio-label border rounded-lg p-3 text-center transition-all ${scores[id] === n.val ? 'ring-2 ring-green-500 shadow-md transform scale-105 z-10 ' + n.color : 'bg-white border-gray-200 text-gray-500 hover:bg-gray-50'}`}>
                                                    <input type="radio" name={id} value={n.val} checked={scores[id] === n.val} onChange={() => handleScore(id, n.val)} className="hidden" />
                                                    <div className="font-bold text-2xl mb-1">{n.val}</div>
                                                    <div className="text-xs uppercase font-bold tracking-wider">{n.label}</div>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                                <div className="mt-8">
                                    <label className="block font-bold text-gray-700 mb-2">Comentarios Adicionales (Opcional)</label>
                                    <textarea className="input-field h-24 w-full resize-none" placeholder="Escribe aqu√≠ observaciones..." value={comentario} onChange={(e) => setComentario(e.target.value)}></textarea>
                                </div>
                                <div className="mt-8 pt-6 border-t border-gray-100">
                                    <button onClick={guardarEvaluacion} disabled={isSaving} className="w-full btn btn-primary flex justify-center items-center gap-3 text-lg py-4 shadow-lg active:scale-95 transform transition-transform">
                                        {isSaving ? <div className="loader"></div> : <><svg className="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg> Guardar Evaluaci√≥n</>}
                                    </button>
                                </div>
                                {mensaje && <div className={`mt-4 p-4 text-center rounded-lg font-bold animate-bounce ${mensaje.includes('‚úÖ') ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>{mensaje}</div>}
                            </div>
                        </div>

                        {/* Columna Derecha */}
                        <div className="lg:col-span-1">
                            <div className="card p-6 sticky top-6 bg-gray-50 border border-gray-200">
                                <h3 className="font-bold text-gray-800 mb-4 flex justify-between items-center border-b pb-3 border-gray-200">
                                    <span>Evaluaciones</span>
                                    <span className="bg-green-600 text-white text-xs px-2 py-1 rounded-full shadow">{history.length}</span>
                                </h3>
                                <div className="max-h-[600px] overflow-y-auto space-y-3 mb-6 pr-1 custom-scrollbar">
                                    {history.length === 0 ? (
                                        <div className="text-center py-12 opacity-50">
                                            <div className="text-4xl mb-2">üìä</div>
                                            <p className="text-sm text-gray-500">A√∫n no hay registros en esta sesi√≥n.</p>
                                        </div>
                                    ) : (
                                        history.map((h, i) => (
                                            <div key={i} className="bg-white p-3 rounded-lg border border-gray-200 text-sm shadow-sm hover:shadow-md transition-shadow">
                                                <div className="flex justify-between font-bold text-gray-800 mb-1">
                                                    <span className="truncate w-3/4" title={h.evaluado_nombre}>{h.evaluado_nombre}</span>
                                                    <span className={`px-2 rounded text-xs flex items-center ${h.promedio >= 2.5 ? 'bg-green-100 text-green-800' : h.promedio >= 1.5 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}`}>
                                                        {h.promedio}
                                                    </span>
                                                </div>
                                                <p className="text-xs text-gray-500 flex items-center gap-1">
                                                    <span className="w-2 h-2 rounded-full bg-gray-300"></span> Eval: *CONFIDENCIAL*
                                                </p>
                                                <div className="flex justify-between text-[10px] text-gray-400 mt-2 border-t pt-1">
                                                    <span>{h.fecha}</span>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                                <button onClick={exportarExcel} disabled={isDownloading} className="w-full btn bg-slate-800 text-white hover:bg-slate-900 flex justify-center items-center gap-2 text-sm py-3 shadow-md">
                                    {isDownloading ? <div className="loader"></div> : <><svg className="w-4 h-4 inline mr-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg> Descargar Excel Privado</>}
                                </button>
                                <p className="text-[10px] text-center text-gray-400 mt-3 leading-tight">* El archivo Excel generado es confidencial y toma los datos directamente de la base de datos.</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>